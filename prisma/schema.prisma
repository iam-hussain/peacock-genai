// Modern Fintech-aligned Prisma Schema
// Clean separation: Identity, Finance, Analytics

generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "mongodb"
}

// ============================================================================
// ENUMS
// ============================================================================

enum AccountRole {
    SUPER_ADMIN
    ADMIN
    MEMBER
}

enum AccountType {
    MEMBER
    VENDOR
    CLUB
    SYSTEM
}

enum AccountStatus {
    ACTIVE
    INACTIVE
    BLOCKED
    CLOSED
}

enum AccessLevel {
    READ
    WRITE
    ADMIN
}

enum TransactionMethod {
    CASH
    ACCOUNT
    UPI
    BANK
    CHEQUE
}

enum TransactionType {
    PERIODIC_DEPOSIT
    OFFSET_DEPOSIT
    WITHDRAW
    REJOIN
    FUNDS_TRANSFER
    VENDOR_INVEST
    VENDOR_RETURNS
    LOAN_TAKEN
    LOAN_REPAY
    LOAN_INTEREST
}

enum PassbookKind {
    MEMBER
    VENDOR
    CLUB
}

// ============================================================================
// ACCOUNT - Identity + Access Only
// ============================================================================

model Account {
    id String @id @default(auto()) @map("_id") @db.ObjectId

    // Classification
    type   AccountType   @default(MEMBER)
    role   AccountRole   @default(MEMBER)
    status AccountStatus @default(ACTIVE)

    // Identity
    firstName String
    lastName  String?
    phone     String?
    avatarUrl String? @map("avatar")

    // Authentication
    username     String  @unique
    email        String?
    passwordHash String?
    canLogin     Boolean @default(false)

    // Authorization (single source of truth)
    accessLevel AccessLevel @default(READ)

    // Audit
    accessUpdatedAt   DateTime?
    accessUpdatedById String?   @db.ObjectId

    // Legacy passbook (read-only) - TRANSITIONAL
    passbookId String?   @unique @db.ObjectId
    passbook   Passbook? @relation(fields: [passbookId], references: [id])

    // Transactions
    outgoingTransactions Transaction[] @relation("FromAccount")
    incomingTransactions Transaction[] @relation("ToAccount")
    createdTransactions  Transaction[] @relation("CreatedBy")
    updatedTransactions  Transaction[] @relation("UpdatedBy")

    // Lifecycle
    startedAt DateTime  @default(now()) @map("startAt")
    endedAt   DateTime? @map("endAt")
    active    Boolean   @default(true)

    lastLoginAt DateTime?
    createdAt   DateTime  @default(now())
    updatedAt   DateTime  @updatedAt
}

// ============================================================================
// TRANSACTION - Financial Source of Truth
// ============================================================================

model Transaction {
    id String @id @default(auto()) @map("_id") @db.ObjectId

    // Parties
    fromId String  @db.ObjectId
    toId   String  @db.ObjectId
    from   Account @relation("FromAccount", fields: [fromId], references: [id], onDelete: Cascade)
    to     Account @relation("ToAccount", fields: [toId], references: [id], onDelete: Cascade)

    // Financial
    amount   Float
    currency String @default("INR")

    // Classification
    type   TransactionType   @default(PERIODIC_DEPOSIT) @map("transactionType")
    method TransactionMethod @default(ACCOUNT)

    // Timing
    occurredAt DateTime  @default(now()) @map("transactionAt")
    postedAt   DateTime? // When it was processed/confirmed

    // Metadata
    referenceId String? // External reference (cheque #, UPI ref, etc)
    description String?  @map("note")
    tags        String[] @default([])

    // Audit
    createdById String?  @db.ObjectId
    createdBy   Account? @relation("CreatedBy", fields: [createdById], references: [id])
    updatedById String?  @db.ObjectId
    updatedBy   Account? @relation("UpdatedBy", fields: [updatedById], references: [id])

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([occurredAt])
    @@index([type, occurredAt])
    @@index([fromId, occurredAt])
    @@index([toId, occurredAt])
    @@index([method])
}

// ============================================================================
// PASSBOOK - Legacy / Transitional (Read-Only)
// ============================================================================

model Passbook {
    id String @id @default(auto()) @map("_id") @db.ObjectId

    // Legacy JSON payloads (DO NOT USE FOR NEW FEATURES)
    payload     Json? @default("{}")
    loanHistory Json? @default("[]")

    kind PassbookKind @default(MEMBER) @map("type")

    // Link to account
    account   Account?
    accountId String?

    // Calculated fields (deprecated - use Transaction aggregations)
    currentBalance   Float @default(0)
    totalDeposits    Float @default(0)
    totalWithdrawals Float @default(0)

    // Adjustments (legacy)
    joiningOffset Float @default(0)
    delayOffset   Float @default(0)

    // Metadata
    meta             Json?
    version          Int       @default(0)
    lastCalculatedAt DateTime?
    isChit           Boolean   @default(true)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([kind])
    @@map("passbooks")
}

// ============================================================================
// SUMMARY - Monthly Snapshot (Dashboard & Graph Source of Truth)
// ============================================================================

model Summary {
    id String @id @default(auto()) @map("_id") @db.ObjectId

    // Period
    monthStartDate DateTime
    monthEndDate   DateTime

    // Members
    activeMembers Int @default(0)
    clubAgeMonths Int @default(0)

    // Member Funds
    totalDeposits     Float @default(0)
    memberBalance     Float @default(0)
    profitWithdrawals Float @default(0)
    memberAdjustments Float @default(0)

    // Loans - Lifetime
    totalLoanGiven         Float @default(0)
    totalInterestCollected Float @default(0)

    // Loans - Active / Outstanding
    currentLoanTaken Float @default(0)
    interestBalance  Float @default(0)

    // Vendor
    vendorInvestment Float @default(0)
    vendorProfit     Float @default(0)

    // Cash Flow
    totalInvested  Float @default(0)
    pendingAmounts Float @default(0)

    // Valuation
    availableCash Float @default(0)
    currentValue  Float @default(0)

    // Portfolio
    totalPortfolioValue Float @default(0)

    // System
    recalculatedAt        DateTime @default(now())
    recalculatedByAdminId String?  @db.ObjectId
    isLocked              Boolean  @default(false)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}
